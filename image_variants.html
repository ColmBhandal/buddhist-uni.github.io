---
layout: nil
permalink: image_variants.bash
comment: |
  This is an html file with frontmatter so that jekyll will process it.
  It will become a bash script per the permalink above,
  which the Build script moves out and executes.
convops: "-verbose -strip -define webp:method=4 -define webp:pass=5 -define webp:target-psnr=49"
# "verbose" echos each write it does
# "strip"s metadata
# "method" is a 1-6 scale from Fastest to Best Compression (each step ~= +20% time/-1.4% size)
# "pass" tells it to do N passes to dial in the quality (5=inconsistent -> 7=reliable)
# which is "target"ting a Peak Signal-to-Noise-Ratio ("psnr") of 49 dB (~0.002% error, near the limit for 8-bit images)
---
#!/bin/bash
{% capture outdir %}{{site.destination}}/derived_imgs/{% endcapture %}echo "Outputting to {{ outdir }}"
rm -rf '{{outdir}}'
cd "{{ site.source }}/../imgs"

{% capture sourceurl %}{{site.data.content.filehost}}imgs/{% endcapture %}
{% assign pages = site.courses | where: "part_of_course", "imagery" | where_exp: "p", "p.image contains sourceurl" %}
echo "====IMAGERY COURSE IMAGES===="
mkdir -p '{{outdir}}imagery'
{% for p in pages %}
{% assign sourceimg = p.image | replace: sourceurl, '' %}
convert '{{sourceimg}}' {{ page.convops }} \
  -resize '1066x1280>' -write '{{outdir}}{{sourceimg | replace: ".JPG", ".webp" }}' \
  -resize 533 '{{outdir}}{{sourceimg | replace: ".JPG", "-1x.webp" }}'{% assign foreground = forloop.rindex | modulo: 2 %}{% if foreground == 0 %} &>.out &
pid=$!{% elsif forloop.index >= 2 %}
wait $pid
cat .out
{% endif %}{% endfor %}

echo "====BUDDHISM+FUNCTION COURSE IMAGES===="
{% assign pages = site.courses | where_exp: "p", "p.image contains sourceurl and p.part_of_course contains 'u'" %}{% comment %}UGLY FRAGILE HACK as "imagery" happens to not contain a 'u' while buddhism and function do not{% endcomment %}
mkdir '{{outdir}}buddhism'
mkdir '{{outdir}}function'
{%- for p in pages -%}
{%- assign foreground = forloop.rindex | modulo: 2 -%}
{%- assign sourceimg = p.image | replace: sourceurl, '' | replace: "%2C", "," -%}
{%- assign dest = sourceimg | replace: '.jpg', '.webp' | replace: '.jpeg', '.webp' | replace: '.png', '.webp' -%}
{% if p.image_height > p.image_width and p.image_height >= 1536 %}
convert "{{sourceimg}}" {{ page.convops }} \
  -resize '1920x1920>' -write "{{outdir}}{{ dest }}" \
  -resize '1280x1280>' -write "{{outdir}}{{ dest | replace: ".webp", "-2x.webp" }}" \
{% else %}
convert "{{sourceimg}}" {{ page.convops }} \
  -resize '1280x1280>' -write "{{outdir}}{{ dest }}" \
{% endif %}  -resize '640x640>' "{{outdir}}{{ dest | replace: ".webp", "-1x.webp" }}"{% if foreground == 0 %} &>.out &
pid=$!
{% elsif forloop.index >= 2 %}
wait $pid
cat .out
{% endif %}{% endfor %}

rm .out
