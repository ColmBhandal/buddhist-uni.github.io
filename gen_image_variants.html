---
layout: nil
permalink: imgscript/gen_image_variants.bash
comment: |
  This is an html file with frontmatter so that jekyll will process it.
  It will become a bash script per the permalink above,
  which the Build script moves out and executes.
convops: "-verbose -strip -define webp:method=4 -define webp:pass=5 -define webp:target-psnr=49"
# "verbose" echos each write it does
# "strip"s metadata
# "method" is a 1-6 scale from Fastest to Best Compression (each step ~= +20% time/-1.4% size)
# "pass" tells it to do N passes to dial in the quality (5=inconsistent -> 7=reliable)
# which is "target"ting a Peak Signal-to-Noise-Ratio ("psnr") of 49 dB (~0.002% error, near the limit for 8-bit images)
---
#!/bin/bash
{% capture outdir %}$GITHUB_WORKSPACE/output/{% endcapture %}echo "Outputting to {{ outdir }}"
cd imgs

{% capture sourceurl %}{{site.data.content.filehost}}imgs/{% endcapture %}
{% assign pages = site.courses | where: "part_of_course", "imagery" | where_exp: "p", "p.image contains sourceurl" %}
echo "====IMAGERY COURSE IMAGES===="
mkdir -p '{{outdir}}imagery'
{% for p in pages %}
{% assign sourceimg = p.image | replace: sourceurl, '' %}
convert '{{sourceimg}}' {{ page.convops }} \
  -resize '1066x1280>' -write '{{outdir}}{{sourceimg | replace: ".JPG", ".webp" }}' \
  -resize 533 '{{outdir}}{{sourceimg | replace: ".JPG", "-1x.webp" }}'{% assign foreground = forloop.rindex | modulo: 2 %}{% if foreground == 0 %} &>.out &
pid=$!{% elsif forloop.index >= 2 %}
wait $pid
cat .out
{% endif %}{% endfor %}

echo "====BUDDHISM+FUNCTION COURSE IMAGES===="
{% assign pages = site.courses | where_exp: "p", "p.image contains sourceurl and p.part_of_course contains 'u'" %}{% comment %}UGLY FRAGILE HACK as "imagery" happens to not contain a 'u' while buddhism and function do not{% endcomment %}
mkdir '{{outdir}}buddhism'
mkdir '{{outdir}}function'
{%- for p in pages -%}
{%- assign foreground = forloop.rindex | modulo: 2 -%}
{%- assign sourceimg = p.image | replace: sourceurl, '' | replace: "%2C", "," -%}
{%- assign dest = sourceimg | replace: '.jpg', '.webp' | replace: '.jpeg', '.webp' | replace: '.png', '.webp' -%}
{% if p.image_height > p.image_width and p.image_height >= 1536 %}
convert "{{sourceimg}}" {{ page.convops }} \
  -resize '1920x1920>' -write "{{outdir}}{{ dest }}" \
  -resize '1280x1280>' -write "{{outdir}}{{ dest | replace: ".webp", "-2x.webp" }}" \
{% else %}
convert "{{sourceimg}}" {{ page.convops }} \
  -resize '1280x1280>' -write "{{outdir}}{{ dest }}" \
{% endif %}  -resize '640x640>' "{{outdir}}{{ dest | replace: ".webp", "-1x.webp" }}"{% if foreground == 0 %} &>.out &
pid=$!
{% elsif forloop.index >= 2 %}
wait $pid
cat .out
{% endif %}{% endfor %}
rm .out

echo "====BIG_IMAGE BANNERS===="
cd ../original_size_imgs
mkdir {{outdir}}banners
{% assign pages = site.documents | concat: site.pages | uniq | where_exp: "p", "p.big_image" %}
{%- for p in pages -%}
{%- assign foreground = forloop.rindex | modulo: 2 -%}
{%- if p.footer_info -%}
  {%- assign height = 650 -%}
  {%- if p.path == "index.html" -%}{%- assign height = 900 -%}{%- endif -%}
{%- else -%}
  {%- if p.next_courses -%}{%- assign height = 680 -%}
  {%- elsif site.header_pages contains p.path -%}{%- assign height = 200 -%}
  {%- else -%}{%- assign height = 240 -%}{%- endif -%}
{%- endif -%}
{%- assign imagename = p.big_image | split: "/" | last | replace: "%26", "&" | replace: "%27", "'" | replace: "%2C", "," | replace: "%3B", ";" | replace: "%28", "(" | replace: "%29", ")" -%}
{%- assign dest = outdir | append: "banners/" | append: imagename | replace: '.jpg', '.webp' | replace: '.jpeg', '.webp' | replace: '.JPG', '.webp' -%}
{%- assign th = height | times: 2 -%}
{%- assign adest = dest | replace: ".webp", "-400-2x.webp" -%}
{%- assign bdest = dest | replace: ".webp", "-640-1x.webp" -%}
{%- assign cdest = dest | replace: ".webp", "-640-2x.webp" -%}
{%- assign ddest = dest | replace: ".webp", "-1920-1x.webp" -%}
{%- assign edest = dest | replace: ".webp", "-1920-2x.webp" -%}
{%- assign fdest = dest | replace: ".webp", "-2880-2x.webp" -%}
convert "{{ imagename }}" {{ page.convops }} -write mpr:orig \
  {% include ratio-resize.magick th=th aw=p.big_width ah=p.big_height cx=p.image_center_x cy=p.image_center_y last=false tw=2880 tfname=fdest %} +delete \
  mpr:orig {% include ratio-resize.magick th=height aw=p.big_width ah=p.big_height cx=p.image_center_x cy=p.image_center_y last=false tw=1920 tfname=ddest %} +delete \
  mpr:orig {% include ratio-resize.magick th=th aw=p.big_width ah=p.big_height cx=p.image_center_x cy=p.image_center_y last=false tw=1920 tfname=edest %} +delete \
  mpr:orig {% if p.next_courses and p.banner_info %}{% assign height = 480 %}{% assign th = 960 %}{% endif %}{% include ratio-resize.magick aw=p.big_width ah=p.big_height cx=p.image_center_x cy=p.image_center_y last=false tw=1280 th=th tfname=cdest %} \
  -resize '640x{{ height }}>' -write "{{ bdest }}" +delete \
  mpr:orig {% include ratio-resize.magick aw=p.big_width ah=p.big_height cx=p.image_center_x cy=p.image_center_y last=true tw=800 th=th tfname=adest %}{% if foreground == 0 %} &>.out &
pid=$!
{% elsif forloop.index >= 2 %}
wait $pid
cat .out
{% else %}
{% endif %}{% endfor %}
rm .out
